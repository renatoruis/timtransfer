services:
  cleanup:
    build: .
    image: ghcr.io/renatoruis/timtransfer:main
    env_file: .env
    environment:
      - EXPIRY_HOURS=${EXPIRY_HOURS:-1}
    volumes:
      - ./uploads:/app/uploads
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "[Cleanup] Job iniciado. Executando a cada 5 minutos."
        while true; do
          node scripts/cleanup.js
          sleep 300
        done
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.25"

  app:
    build: .
    image: ghcr.io/renatoruis/timtransfer:main
    ports:
      - "9090:9090"
    env_file: .env
    environment:
      - PORT=9090
      - MAX_UPLOADS_DISK_MB=${MAX_UPLOADS_DISK_MB:-1024}
      - EXPIRY_HOURS=${EXPIRY_HOURS:-1}
      - RECAPTCHA_SITE_KEY=${RECAPTCHA_SITE_KEY}
      - RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY}
    volumes:
      - ./uploads:/app/uploads
      - ./feedback:/app/feedback
      - ./metrics:/app/metrics
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1"
        reservations:
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
