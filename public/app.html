<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TimTransfer - Enviar arquivos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif; }
    body { background: #f5f5f7; }
    .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
    .glass-border { border: 1px solid rgba(0,0,0,0.04); }
    .shadow-soft { box-shadow: 0 2px 16px rgba(0,0,0,0.04), 0 4px 32px rgba(0,0,0,0.03); }
    .shadow-soft-hover:hover { box-shadow: 0 4px 24px rgba(0,0,0,0.06), 0 8px 48px rgba(0,0,0,0.04); }
    .drop-zone.drag-over { background: rgba(0,113,227,0.06); border-color: rgba(0,113,227,0.3); }
    .btn-primary { background: #0071e3; color: white; }
    .btn-primary:hover { background: #0077ed; }
    .pin-input:focus { box-shadow: 0 0 0 2px rgba(0,113,227,0.4); }
    .toast { animation: fadeUp 0.25s cubic-bezier(0.4,0,0.2,1); }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="min-h-screen text-[#1d1d1f] flex flex-col">
  <header class="mt-4 px-6 max-w-5xl mx-auto w-full flex justify-center">
    <a href="/" class="inline-block">
      <img src="/images/TimTransferLogo.png" alt="TimTransfer — fácil, grátis e seguro" class="h-16" />
    </a>
  </header>

  <main class="flex-1 py-12 px-6 flex flex-col items-center justify-center">
    <div class="w-full max-w-[420px]">
    <h1 class="text-[28px] font-semibold text-center tracking-tight text-[#1d1d1f] mb-10">Enviar arquivos</h1>

    <div class="mb-8 p-6 rounded-2xl glass glass-border shadow-soft shadow-soft-hover transition-all duration-300">
      <p class="text-[13px] text-[#86868b] mb-4 font-medium">Crie uma senha para os arquivos.</p>
      <div class="flex justify-center gap-3">
        <input type="password" id="pin0" inputmode="numeric" maxlength="1" autocomplete="off"
          class="pin-input w-12 h-12 text-center text-[17px] font-semibold rounded-xl bg-white/60 border border-[#d2d2d7] text-[#1d1d1f] focus:outline-none focus:border-transparent transition-shadow duration-200" />
        <input type="password" id="pin1" inputmode="numeric" maxlength="1" autocomplete="off"
          class="pin-input w-12 h-12 text-center text-[17px] font-semibold rounded-xl bg-white/60 border border-[#d2d2d7] text-[#1d1d1f] focus:outline-none focus:border-transparent transition-shadow duration-200" />
        <input type="password" id="pin2" inputmode="numeric" maxlength="1" autocomplete="off"
          class="pin-input w-12 h-12 text-center text-[17px] font-semibold rounded-xl bg-white/60 border border-[#d2d2d7] text-[#1d1d1f] focus:outline-none focus:border-transparent transition-shadow duration-200" />
        <input type="password" id="pin3" inputmode="numeric" maxlength="1" autocomplete="off"
          class="pin-input w-12 h-12 text-center text-[17px] font-semibold rounded-xl bg-white/60 border border-[#d2d2d7] text-[#1d1d1f] focus:outline-none focus:border-transparent transition-shadow duration-200" />
      </div>
    </div>

    <div id="dropZone" class="drop-zone hidden rounded-2xl py-12 px-8 text-center cursor-pointer transition-all duration-300 glass glass-border shadow-soft shadow-soft-hover border-2 border-dashed border-[#d2d2d7] hover:border-[#0071e3]/40">
      <input type="file" id="fileInput" class="hidden" multiple />
      <div class="w-12 h-12 mx-auto mb-2 rounded-2xl bg-[#0071e3]/10 flex items-center justify-center">
        <svg class="w-6 h-6 text-[#0071e3]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/></svg>
      </div>
      <p id="dropZoneText" class="text-[15px] text-[#86868b] font-medium">Arraste ou clique para adicionar arquivos</p>
    </div>

    <div id="pendingFiles" class="mt-4 hidden p-4 rounded-2xl glass glass-border shadow-soft">
      <p class="text-[13px] text-[#86868b] font-medium mb-3">Arquivos selecionados</p>
      <ul id="pendingFileList" class="mb-3 max-h-36 overflow-y-auto space-y-2 text-[15px]"></ul>
      <p id="pendingTotal" class="text-[13px] text-[#86868b] mb-3 font-medium"></p>
      <button type="button" id="uploadBtn" class="w-full py-3 rounded-xl bg-[#0071e3] hover:bg-[#0077ed] text-white text-[15px] font-semibold transition-colors">
        Enviar arquivos
      </button>
    </div>

    <div id="uploadProgress" class="mt-6 hidden p-4 rounded-2xl glass glass-border shadow-soft">
      <div class="flex items-center gap-3 mb-3">
        <svg class="animate-spin w-5 h-5 text-[#0071e3] shrink-0" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="progressText" class="text-[15px] text-[#1d1d1f] font-medium">Enviando arquivos...</p>
      </div>
      <div class="h-2 bg-[#d2d2d7]/50 rounded-full overflow-hidden">
        <div id="progressBar" class="h-full bg-[#0071e3] rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
      </div>
    </div>

    <div id="result" class="mt-8 hidden p-6 rounded-2xl glass glass-border shadow-soft">
      <ul id="fileList" class="mb-4 max-h-36 overflow-y-auto space-y-2 text-[15px]"></ul>
      <p id="totalSize" class="text-[13px] text-[#86868b] mb-5 font-medium"></p>
      <div class="flex gap-3">
        <input type="text" id="shareUrl" readonly class="flex-1 rounded-xl px-4 py-3 text-[14px] bg-white/50 border border-[#d2d2d7] text-[#1d1d1f] truncate focus:outline-none focus:border-[#0071e3]/50" />
        <button type="button" id="copyBtn" class="shrink-0 px-5 py-3 rounded-xl btn-primary text-[14px] font-semibold transition-colors duration-200">Copiar</button>
      </div>
    </div>

    <div id="error" class="mt-4 py-3 px-4 rounded-xl bg-[#ff3b30]/10 text-[#ff3b30] text-[14px] hidden font-medium"></div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 px-5 py-3 rounded-xl bg-[#1d1d1f] text-white text-[14px] font-medium shadow-soft toast hidden z-50">Copiado</div>
    </div>
  </main>

  <footer class="mt-auto py-8 px-6 border-t border-[#d2d2d7]/50 bg-[#f5f5f7]">
    <div class="max-w-5xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <span class="text-[13px] text-[#86868b]">TimTransfer — gratuito, simples, seguro.</span>
      <div class="flex items-center gap-6">
        <button type="button" id="feedbackBtn" class="text-[14px] text-[#86868b] hover:text-[#0071e3] transition-colors">
          Enviar sugestão
        </button>
        <button type="button" id="coffeeBtn" class="text-[14px] text-[#86868b] hover:text-[#0071e3] transition-colors">
          Me pague um café
        </button>
        <a href="https://github.com/renatoruis/timtransfer" target="_blank" rel="noopener" class="text-[14px] text-[#86868b] hover:text-[#0071e3] transition-colors flex items-center gap-1">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          Dar uma estrela
        </a>
      </div>
    </div>
  </footer>

  <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-xl" onclick="event.stopPropagation()">
      <h3 class="text-[20px] font-semibold text-center mb-2">Me pague um café</h3>
      <p class="text-[14px] text-[#86868b] text-center mb-4">Escaneie o QR code ou copie a chave PIX</p>
      <img src="/images/qrcode-pix.png" alt="QR Code PIX" class="w-48 h-48 mx-auto rounded-lg mb-4" />
      <p class="text-[13px] text-[#86868b] mb-1">Chave PIX</p>
      <p id="pixKey" class="font-mono text-[14px] text-[#1d1d1f] mb-3 break-all select-all">a7f1a823-d3b5-4ab3-b63f-03ffed9459f7</p>
      <button type="button" id="copyPixBtn" class="w-full py-3 rounded-xl bg-[#0071e3] hover:bg-[#0077ed] text-white text-[15px] font-medium mb-3 transition-colors">Copiar chave</button>
      <button type="button" id="closeModal" class="w-full py-3 rounded-xl bg-[#f5f5f7] text-[#1d1d1f] text-[15px] font-medium hover:bg-[#e8e8ed] transition-colors">
        Fechar
      </button>
    </div>
  </div>

  <div id="feedbackModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-[20px] font-semibold text-[#1d1d1f]">Enviar sugestão</h3>
        <button type="button" id="feedbackClose" class="text-[#86868b] hover:text-[#1d1d1f] p-1 rounded-lg transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <p class="text-[14px] text-[#86868b] mb-4">Envie uma sugestão, melhoria, crítica ou peça suporte. Resposta apenas se informar e-mail.</p>
      <form id="feedbackForm">
        <div class="mb-4">
          <label class="block text-[13px] font-medium text-[#1d1d1f] mb-2">Tipo</label>
          <select id="feedbackType" class="w-full rounded-xl px-4 py-3 text-[15px] bg-[#f5f5f7] border border-[#d2d2d7] text-[#1d1d1f] focus:outline-none focus:border-[#0071e3]/50">
            <option value="sugestao">Sugestão</option>
            <option value="melhoria">Melhoria</option>
            <option value="critica">Crítica</option>
            <option value="suporte">Suporte</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-[13px] font-medium text-[#1d1d1f] mb-2">E-mail (opcional)</label>
          <input type="email" id="feedbackEmail" class="w-full rounded-xl px-4 py-3 text-[15px] bg-[#f5f5f7] border border-[#d2d2d7] text-[#1d1d1f] focus:outline-none focus:border-[#0071e3]/50" placeholder="seu@email.com">
        </div>
        <div class="mb-4">
          <label class="block text-[13px] font-medium text-[#1d1d1f] mb-2">Mensagem</label>
          <textarea id="feedbackMessage" name="message" rows="4" required class="w-full rounded-xl px-4 py-3 text-[15px] bg-[#f5f5f7] border border-[#d2d2d7] text-[#1d1d1f] focus:outline-none focus:border-[#0071e3]/50 resize-none" placeholder="Descreva sua sugestão, melhoria, crítica ou pedido de suporte..."></textarea>
        </div>
        <p id="feedbackError" class="text-[#ff3b30] text-[14px] mb-3 hidden"></p>
        <p id="feedbackSuccessMsg" class="text-[#34c759] text-[14px] mb-3 hidden">Enviado! Obrigado pelo feedback.</p>
        <div class="flex gap-3">
          <button type="button" id="feedbackCloseBtn" class="flex-1 py-3 rounded-xl bg-[#f5f5f7] text-[#1d1d1f] text-[15px] font-medium hover:bg-[#e8e8ed] transition-colors">Cancelar</button>
          <button type="submit" id="feedbackSubmit" class="flex-1 py-3 rounded-xl bg-[#0071e3] hover:bg-[#0077ed] text-white text-[15px] font-medium transition-colors">Enviar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/feedback.js"></script>
  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const dropZoneText = document.getElementById('dropZoneText');
    const pendingFiles = document.getElementById('pendingFiles');
    const pendingFileList = document.getElementById('pendingFileList');
    const pendingTotal = document.getElementById('pendingTotal');
    const uploadBtn = document.getElementById('uploadBtn');
    const result = document.getElementById('result');
    const fileList = document.getElementById('fileList');
    const totalSize = document.getElementById('totalSize');
    const shareUrl = document.getElementById('shareUrl');
    const copyBtn = document.getElementById('copyBtn');
    const errorEl = document.getElementById('error');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const toast = document.getElementById('toast');

    const MAX_SESSION_BYTES = 100 * 1024 * 1024;
    const BLOCKED_EXT = ['.exe','.com','.bat','.cmd','.msi','.scr','.vbs','.ps1','.pif','.hta','.cpl','.msc','.jar','.dll','.sys','.reg','.inf','.wsf','.vbe','.jse'];

    function formatBytes(n) {
      if (n < 1024) return n + ' B';
      if (n < 1024 * 1024) return (n / 1024).toFixed(1) + ' KB';
      return (n / (1024 * 1024)).toFixed(1) + ' MB';
    }
    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }
    function renderFileList(files) {
      fileList.innerHTML = '';
      let sum = 0;
      files.forEach(f => {
        const li = document.createElement('li');
        li.className = 'flex justify-between py-1';
        li.innerHTML = '<span class="truncate mr-3 text-[#1d1d1f]" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</span><span class="text-[#86868b] shrink-0 text-[13px] font-medium">' + formatBytes(f.size) + '</span>';
        fileList.appendChild(li);
        sum += f.size;
      });
      totalSize.textContent = files.length + ' arquivo(s) · ' + formatBytes(sum);
    }

    function showError(msg) {
      errorEl.textContent = msg;
      errorEl.classList.remove('hidden');
    }
    function hideError() {
      errorEl.classList.add('hidden');
    }
    function showToast(msg) {
      toast.textContent = msg || 'Copiado';
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 1800);
    }

    let selectedFiles = [];

    function addFiles(newFiles) {
      hideError();
      const files = Array.from(newFiles || []);
      if (files.length === 0) return;
      const blocked = files.find(f => {
        const name = f.name || '';
        const ext = (name.includes('.') ? '.' + name.split('.').pop() : '').toLowerCase();
        return ext && BLOCKED_EXT.includes(ext);
      });
      if (blocked) {
        showError('Tipo de arquivo não permitido: ' + (blocked.name || 'arquivo'));
        return;
      }
      const newTotal = selectedFiles.reduce((s, f) => s + f.size, 0) + files.reduce((s, f) => s + f.size, 0);
      if (newTotal > MAX_SESSION_BYTES) {
        showError('Limite: 100MB no total. Adicione menos arquivos.');
        return;
      }
      selectedFiles.push(...files);
      renderPendingFiles();
    }

    function renderPendingFiles() {
      pendingFileList.innerHTML = '';
      if (selectedFiles.length === 0) {
        pendingFiles.classList.add('hidden');
        dropZoneText.textContent = 'Arraste ou clique para adicionar arquivos';
        return;
      }
      pendingFiles.classList.remove('hidden');
      dropZoneText.textContent = 'Adicionar mais arquivos';
      const total = selectedFiles.reduce((s, f) => s + f.size, 0);
      selectedFiles.forEach((f, i) => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center py-1.5';
        li.innerHTML = '<span class="truncate mr-2 text-[#1d1d1f]" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</span>' +
          '<span class="flex items-center gap-2 shrink-0"><span class="text-[#86868b] text-[13px] font-medium">' + formatBytes(f.size) + '</span>' +
          '<button type="button" data-i="' + i + '" class="remove-file text-[#ff3b30] hover:text-[#ff3b30]/80 text-sm font-medium px-1.5 py-0.5 rounded hover:bg-[#ff3b30]/10" title="Remover">✕</button></span>';
        pendingFileList.appendChild(li);
      });
      pendingTotal.textContent = selectedFiles.length + ' arquivo(s) · ' + formatBytes(total);
      pendingFileList.querySelectorAll('.remove-file').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedFiles.splice(parseInt(btn.dataset.i, 10), 1);
          renderPendingFiles();
        });
      });
    }

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      addFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', () => {
      addFiles(fileInput.files);
      fileInput.value = '';
    });

    uploadBtn.addEventListener('click', function doUpload() {
      if (selectedFiles.length === 0) return;
      const password = getPinValue();
      if (!/^\d{4}$/.test(password)) {
        showError('Senha inválida. Use 4 números.');
        return;
      }
      const total = selectedFiles.reduce((s, f) => s + f.size, 0);
      if (total > MAX_SESSION_BYTES) {
        showError('Limite: 100MB por sessão.');
        return;
      }

      result.classList.add('hidden');
      pendingFiles.classList.add('hidden');
      uploadProgress.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = 'Enviando arquivos...';

      const formData = new FormData();
      formData.append('password', password);
      selectedFiles.forEach(f => formData.append('file', f));

      const xhr = new XMLHttpRequest();
      xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = pct + '%';
          const loaded = formatBytes(e.loaded);
          const totalStr = formatBytes(e.total);
          progressText.textContent = 'Enviando... ' + loaded + ' de ' + totalStr + ' (' + pct + '%)';
        }
      });
      xhr.addEventListener('load', function() {
        uploadProgress.classList.add('hidden');
        selectedFiles = [];
        renderPendingFiles();
        try {
          const data = JSON.parse(xhr.responseText);
          if (data.error) {
            showError(data.error);
            return;
          }
          shareUrl.value = data.url;
          renderFileList(data.files || []);
          result.classList.remove('hidden');
        } catch (err) {
          showError('Erro ao enviar.');
        }
      });
      xhr.addEventListener('error', function() {
        uploadProgress.classList.add('hidden');
        showError('Erro ao enviar.');
      });
      xhr.open('POST', '/upload');
      xhr.send(formData);
    });

    const pinInputs = [document.getElementById('pin0'), document.getElementById('pin1'), document.getElementById('pin2'), document.getElementById('pin3')];
    function getPinValue() {
      return pinInputs.map(i => i.value).join('');
    }
    function updateDropZoneVisibility() {
      if (getPinValue().length === 4) {
        dropZone.classList.remove('hidden');
      } else {
        dropZone.classList.add('hidden');
        selectedFiles = [];
        renderPendingFiles();
      }
    }
    pinInputs.forEach((inp, i) => {
      inp.addEventListener('input', (e) => {
        const v = e.target.value.replace(/\D/g, '').slice(0, 1);
        e.target.value = v;
        if (v && i < 3) pinInputs[i + 1].focus();
        updateDropZoneVisibility();
      });
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && i > 0) pinInputs[i - 1].focus();
        setTimeout(updateDropZoneVisibility, 0);
      });
      inp.addEventListener('paste', (e) => {
        e.preventDefault();
        const pasted = (e.clipboardData?.getData('text') || '').replace(/\D/g, '').slice(0, 4);
        pasted.split('').forEach((ch, j) => { if (pinInputs[j]) pinInputs[j].value = ch; });
        if (pasted.length > 0) pinInputs[Math.min(pasted.length - 1, 3)].focus();
        updateDropZoneVisibility();
      });
    });

    copyBtn.addEventListener('click', () => {
      if (shareUrl.value) {
        navigator.clipboard.writeText(shareUrl.value);
        showToast('Copiado');
        copyBtn.textContent = 'Copiado';
        setTimeout(() => { copyBtn.textContent = 'Copiar'; }, 1500);
      }
    });

    var modal = document.getElementById('modal');
    var coffeeBtn = document.getElementById('coffeeBtn');
    var closeModal = document.getElementById('closeModal');
    coffeeBtn.addEventListener('click', function() { modal.classList.remove('hidden'); });
    closeModal.addEventListener('click', function() { modal.classList.add('hidden'); });
    modal.addEventListener('click', function(e) { if (e.target === modal) modal.classList.add('hidden'); });
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') modal.classList.add('hidden'); });
    var copyPixBtn = document.getElementById('copyPixBtn');
    if (copyPixBtn) copyPixBtn.addEventListener('click', function() {
      navigator.clipboard.writeText('a7f1a823-d3b5-4ab3-b63f-03ffed9459f7');
      copyPixBtn.textContent = 'Copiado!';
      setTimeout(function() { copyPixBtn.textContent = 'Copiar chave'; }, 1500);
    });
  </script>
</body>
</html>
